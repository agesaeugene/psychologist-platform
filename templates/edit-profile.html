{% extends 'base.html' %}
{% load static %}

{% block style %}
.card-margin {
    margin-bottom: 1.875rem;
}

.card {
    border: 0;
    box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
    -webkit-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
    -moz-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
    -ms-box-shadow: 0px 0px 10px 0px rgba(82, 63, 105, 0.1);
}

.card {
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #ffffff;
    background-clip: border-box;
    border: 1px solid #e6e4e9;
    border-radius: 8px;
}

.widget-49 {
    padding: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-control {
    border-radius: 4px;
    border: 1px solid #e6e4e9;
    padding: 0.5rem;
}

.btn-primary {
    background-color: #4e73e5;
    border-color: #4e73e5;
}

.btn-primary:hover {
    background-color: #3862e0;
    border-color: #3862e0;
}

.profile-image-preview {
    max-width: 200px;
    margin: 1rem 0;
    border-radius: 50%;
}

.modal-header .btn-close {
    margin: -0.5rem -0.5rem -0.5rem auto;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}

.btn-danger:hover {
    background-color: #bb2d3b;
    border-color: #b02a37;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5c636a;
    border-color: #565e64;
}
{% endblock style %}

{% block content %}
{% if messages %}
<div class="card notification-card notification-invitation">
    <div class="card-body">
        {% for message in messages %}
        <div class="card-title">{{ message }}</div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="container mt-5">
    <div class="col-11 text-center mt-4 mb-4">
        <h3>{% if is_new_profile %}Create New Profile{% else %}Edit Profile{% endif %}</h3>
        <!-- Add New Profile Button -->
        <a href="?new_profile=1" class="btn btn-success mb-4">Add New Profile</a>
    </div>
    
    <!-- Only show existing profiles section if not creating a new profile -->
    {% if not is_new_profile %}
    <div class="row mb-4">
        {% for therapist in therapists %}
        <div class="col-md-4">
            <a href="?profile_id={{ therapist.id }}" class="text-decoration-none">
                <div class="card {% if selected_profile.id == therapist.id %}border-primary{% endif %}">
                    <div class="card-body text-center">
                        {% if therapist.image %}
                            <img src="{{ therapist.image.url }}" 
                                 alt="{{ therapist.name }}" 
                                 class="rounded-circle mb-3" 
                                 style="width: 100px; height: 100px; object-fit: cover;"
                                 onerror="this.src='{% static 'default_profile.png' %}'">
                        {% else %}
                            <img src="{% static 'default_profile.png' %}" 
                                 alt="Default Profile" 
                                 class="rounded-circle mb-3" 
                                 style="width: 100px; height: 100px; object-fit: cover;">
                        {% endif %}
                        <h5 class="card-title">{{ therapist.name }}</h5>
                        <p class="card-text text-muted">{{ therapist.title }}</p>
                        {% if not is_new_profile and object %}
<div class="form-group text-center mt-4">
    <button type="button" class="btn btn-danger" onclick="confirmDelete({{ object.id }})">
        Delete Profile
    </button>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this profile? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
        
    </div>
    {% endif %}
    

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card card-margin">
                <div class="card-body">
                    <div class="widget-49">
                        <form id="profileForm" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            {% if is_new_profile %}
                            <input type="hidden" name="new_profile" value="1">
                            {% endif %}
                            
                            <div class="form-group">
                                <label for="id_name">Name</label>
                                <input type="text" class="form-control" id="id_name" name="name" value="{{ object.name|default:'' }}" required>
                            </div>

                            <div class="form-group">
                                <label for="id_title">Title</label>
                                <input type="text" class="form-control" id="id_title" name="title" value="{{ object.title|default:'' }}" required>
                            </div>

                            <div class="form-group">
                                <label for="id_location">Location</label>
                                <input type="text" class="form-control" id="id_location" name="location" value="{{ object.location|default:'' }}">
                            </div>

                            <div class="form-group">
                                <label for="id_bio">Bio</label>
                                <textarea class="form-control" id="id_bio" name="bio" rows="4">{{ object.bio|default:'' }}</textarea>
                            </div>

                            {% if object.image %}
                            <div class="form-group">
                                <img src="{{ object.image.url }}" 
                                     alt="Profile Image" 
                                     class="profile-image-preview" 
                                     id="currentImage"
                                     onerror="this.src='{% static 'default_profile.png' %}'">
                            </div>
                            {% endif %}

                            <div class="form-group">
                                <label for="id_image">Profile Image</label>
                                <input type="file" class="form-control" id="id_image" name="image" {% if is_new_profile %}required{% endif %}>
                            </div>

                            <div class="form-group">
                                <label for="id_twitter">Twitter Profile URL</label>
                                <input type="url" class="form-control" id="id_twitter" name="twitter" value="{{ object.twitter|default:'' }}">
                            </div>

                            <div class="form-group">
                                <label for="id_linkedin">LinkedIn Profile URL</label>
                                <input type="url" class="form-control" id="id_linkedin" name="linkedin" value="{{ object.linkedin|default:'' }}">
                            </div>

                            <div class="form-group">
                                <label for="id_facebook">Facebook Profile URL</label>
                                <input type="url" class="form-control" id="id_facebook" name="facebook" value="{{ object.facebook|default:'' }}">
                            </div>

                            <div class="form-group">
                                <label for="id_website">Personal Website URL</label>
                                <input type="url" class="form-control" id="id_website" name="website" value="{{ object.website|default:'' }}">
                            </div>

                            <div class="form-group text-center">
                                <button type="submit" class="btn btn-primary" id="updateButton">
                                    {% if is_new_profile %}Create Profile{% else %}Update Profile{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block script %}
<script>

document.getElementById('id_image').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        const imagePreview = document.getElementById('currentImage') || document.createElement('img');
        
        if (!document.getElementById('currentImage')) {
            imagePreview.id = 'currentImage';
            imagePreview.className = 'profile-image-preview';
            e.target.parentNode.insertBefore(imagePreview, e.target.nextSibling);
        }
        
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
        };
        
        reader.readAsDataURL(e.target.files[0]);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profileForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            try {
                const formData = new FormData(form);
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message || 'Profile saved successfully!');
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        window.location.href = window.location.pathname;
                    }
                } else {
                    alert(data.message || 'Error saving profile. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An unexpected error occurred. Please try again.');
            } finally {
                submitButton.disabled = false;
            }
        });
    }
});

function initializeCard(cardNumber) {
    const cardContainer = document.getElementById(`cardContainer${cardNumber}`);
    const toggleData = document.getElementById(`toggleData${cardNumber}`);
    const viewContent = document.getElementById(`viewContent${cardNumber}`);
    const closeContent = document.getElementById(`closeContent${cardNumber}`);
    let isDataVisible = false;

    if (toggleData) {
        toggleData.addEventListener('click', function() {
            isDataVisible = !isDataVisible;
            if (isDataVisible) {
                cardContainer.classList.add('data-visible');
                toggleData.innerHTML = '<span class="material-symbols-outlined">close</span>';
            } else {
                cardContainer.classList.remove('data-visible');
                toggleData.innerHTML = '<span class="material-symbols-outlined">density_large</span>';
            }
        });
    }

    if (viewContent && closeContent) {
        viewContent.addEventListener('click', function() {
            cardContainer.classList.add('content-visible');
        });

        closeContent.addEventListener('click', function() {
            cardContainer.classList.remove('content-visible');
        });
    }
}

// Initialize cards
document.addEventListener('DOMContentLoaded', function() {
    [1, 2, 3].forEach(number => initializeCard(number));
});

let profileToDelete = null;

function confirmDelete(profileId) {
    profileToDelete = profileId;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    if (!profileToDelete) return;
    
    try {
        const formData = new FormData();
        formData.append('profile_id', profileToDelete);
        formData.append('delete_profile', 'true');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
            alert(data.message || 'Profile deleted successfully!');
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            }
        } else {
            alert(data.message || 'Error deleting profile. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An unexpected error occurred. Please try again.');
    }
});

let profileToDelete = null;

function confirmDelete(profileId) {
    profileToDelete = profileId;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    if (!profileToDelete) return;
    
    try {
        const formData = new FormData();
        formData.append('profile_id', profileToDelete);
        formData.append('delete_profile', 'true');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const response = await fetch(window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();
        
        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            modal.hide();
            
            if (data.message) {
                alert(data.message);
            }
            
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.reload();
            }
        } else {
            alert(data.message || 'Error deleting profile. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An unexpected error occurred. Please try again.');
    }
});
</script>
{% endblock script %}
{% endblock content %}